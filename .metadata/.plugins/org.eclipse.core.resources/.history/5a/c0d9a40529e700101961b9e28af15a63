package com.ripplesystem.foobar.test;

import static org.junit.Assert.*;

import java.util.Date;

import org.junit.After;
import org.junit.Before;
import org.junit.Test;

import com.google.appengine.api.datastore.Email;
import com.google.appengine.tools.development.testing.LocalDatastoreServiceTestConfig;
import com.google.appengine.tools.development.testing.LocalServiceTestHelper;
import com.google.inject.Guice;
import com.google.inject.Injector;
import com.ripplesystem.foobar.command.FBAddPoints;
import com.ripplesystem.foobar.command.FBCreateShop;
import com.ripplesystem.foobar.command.FBGetRedeemToken;
import com.ripplesystem.foobar.command.FBGetRedeemToken.Response;
import com.ripplesystem.foobar.command.FBGetShopInfo;
import com.ripplesystem.foobar.command.FBGetStoreListForDevice;
import com.ripplesystem.foobar.command.FBGetTokenForDevice;
import com.ripplesystem.foobar.command.FBRedeemPoints;
import com.ripplesystem.foobar.command.FBUpdateShop;
import com.ripplesystem.foobar.model.ShopInfo;
import com.ripplesystem.foobar.service.FoobarService;

public class FoobarServiceTest
{
	private final LocalServiceTestHelper helper =
	        new LocalServiceTestHelper(new LocalDatastoreServiceTestConfig());
	
	@Before
	public void setUp()
	{
		helper.setUp();
	}
	
	@After
	public void tearDown()
	{
		helper.tearDown();
	}
	
	@Test
	public void testFBServiceInSequence()
	{
		Injector injector = Guice.createInjector(new TestModule());
		FoobarService fbs = injector.getInstance(FoobarService.class);
		
		// This is the beginning of everything
		String deviceId = "7968d30409c82898a293e4da37d689d5df3de471f55678f558a226374a3dab93";
		String deviceId2 = "7968d30409c82898a293e4da37d689d5df3de471f55678f558a226374a3dab94";
		
		// Let's register the device
		FBGetTokenForDevice.Response resToken = testGetTokenForDevice(fbs, deviceId);
		// Let's reigster another device
		FBGetTokenForDevice.Response resToken2 = testGetTokenForDevice(fbs, deviceId2);
		// Test if two devices tokens are different from each other
		assertFalse(resToken.getToken().equals(resToken2.getToken()));
		// Let's register the store
		FBCreateShop.Response resStore = testCreateStore(fbs);
		// Update the store
		FBUpdateShop.Response resUpdateStore = testUpdateStore(fbs, resStore.getShopKey());
		// Get the store
		FBGetShopInfo.Response getStoreInfoRes = testGetStoreInfo(fbs, resStore.getShopKey());
		// Let's give points to this guy
		FBAddPoints.Response res2 = testAddPoints(fbs, resToken.getToken(), resStore.getShopKey());
		// Let's get list of stores
		FBGetStoreListForDevice.Response resStoreList = testGetStoreListForDevice(fbs, deviceId);
		// Let's get redeem token
		FBGetRedeemToken.Response resRedeemToken = testGetRedeemToken(fbs, deviceId, resUpdateStore.getShopKey());
		// Let's subtract points from this dude.
		FBRedeemPoints.Response resRedeemPoints = testRedeemPoints(fbs, resUpdateStore.getShopKey(), resRedeemToken.getRedeemToken());
	}
	
	/**
	 * Hello world
	 */
	public FBGetTokenForDevice.Response testGetTokenForDevice(FoobarService fbs, String deviceId)
	{
		FBGetTokenForDevice cmd = new FBGetTokenForDevice();
		cmd.setDeviceId(deviceId);
		
		FBGetTokenForDevice.Response res1 = (FBGetTokenForDevice.Response)fbs.exec(cmd);
		assertNotNull(res1.getToken());
		
		// Run this for the second time to see if the device and token can be brought from persistence.
		FBGetTokenForDevice.Response res2 = (FBGetTokenForDevice.Response)fbs.exec(cmd);
		assertEquals(res1.getToken(), res2.getToken());
		return res2;
	}
	
	public FBCreateShop.Response testCreateStore(FoobarService fbs)
	{
		FBCreateShop cmd = new FBCreateShop();
		cmd.setName("まんじまけろ〜に");
		cmd.setAddress("東京都八王子西八王子１−２−３");
		cmd.setTel("03-1234-1234");
		cmd.setUrl("http://www.manjimakeroni.com");
		cmd.setImageUrl("http://www.manjimakeroni.com/pic.png");
		cmd.setEmail("izumi@apcandsons.com");
		cmd.setPassword("12345678");
		
		FBCreateShop.Response res = (FBCreateShop.Response)fbs.exec(cmd);
		assertEquals(true, res.isSuccess());
		return res;
	}
	
	public FBUpdateShop.Response testUpdateStore(FoobarService fbs, long storeKey)
	{
		FBUpdateShop cmd = new FBUpdateShop();
		cmd.setShopKey(storeKey);
		cmd.setName("まんじまけろーに");
		cmd.setAddress("東京都八王子西八王子２−３−４");
		cmd.setTel("080-1234-5678");
		cmd.setUrl("http://www.manjimakeroni.net");
		cmd.setImageUrl("http://www.manjimakeroni.net/pic.jpg");
		cmd.setEmail("izumi@apcandsons.net");
		cmd.setPassword("87654321");
		
		FBUpdateShop.Response res = (FBUpdateShop.Response)fbs.exec(cmd);
		return res;
	}
	
	public FBGetShopInfo.Response testGetStoreInfo(FoobarService fbs, long storeKey)
	{
		FBGetShopInfo cmd = new FBGetShopInfo();
		cmd.setShopKey(storeKey);
		FBGetShopInfo.Response res = (FBGetShopInfo.Response)fbs.exec(cmd);
		ShopInfo store = res.getStoreInfo();
		assertEquals("まんじまけろーに", store.getName());
		assertEquals("東京都八王子西八王子２−３−４", store.getAddress());
		assertEquals("080-1234-5678", store.getTel());
		assertEquals("http://www.manjimakeroni.net", store.getUrl());
		assertEquals("http://www.manjimakeroni.net/pic.jpg", store.getImageUrl());
		assertEquals(new Email("izumi@apcandsons.net"), store.getEmail());
		assertEquals("87654321", store.getPassword());
		return res;
	}
	
	public FBAddPoints.Response testAddPoints(FoobarService fbs, String userToken, long storeKey)
	{
		FBAddPoints cmd = new FBAddPoints();
		cmd.setUserToken(userToken);
		cmd.setStoreKey(storeKey);
		cmd.setPoints(100);
		
		{
			FBAddPoints.Response res = (FBAddPoints.Response)fbs.exec(cmd);	
			assertEquals(true, res.isSuccess());
			assertEquals(100, res.getCurrentPoints());
		}

		// Add points one more time
		{
			cmd.setPoints(50);
			FBAddPoints.Response res = (FBAddPoints.Response)fbs.exec(cmd);
			assertEquals(true, res.isSuccess());
			assertEquals(150, res.getCurrentPoints());
			return res;
		}
	}
	
	private FBGetStoreListForDevice.Response testGetStoreListForDevice(FoobarService fbs, String deviceId)
	{
		FBGetStoreListForDevice cmd = new FBGetStoreListForDevice();
		cmd.setDeviceId(deviceId);
		
		FBGetStoreListForDevice.Response res = (FBGetStoreListForDevice.Response)fbs.exec(cmd);
		assertEquals(1, res.getStorePointsInfo().size());
		ShopInfo storeInfo = (ShopInfo)res.getStorePointsInfo().keySet().toArray()[0];
		assertEquals("まんじまけろーに", storeInfo.getName());
		assertEquals((long)150, (long)res.getStorePointsInfo().get(storeInfo));
		return res;
	}

	private Response testGetRedeemToken(FoobarService fbs, String deviceId, long storeKey)
	{
		FBGetRedeemToken cmd = new FBGetRedeemToken();
		cmd.setDeviceId(deviceId);
		cmd.setStoreKey(storeKey);
		
		FBGetRedeemToken.Response res = (FBGetRedeemToken.Response)fbs.exec(cmd);
		assertTrue(res.isSuccess());
		assertNotNull(res.getRedeemToken());
		assertNotNull(res.getExpiration());
		assertTrue(res.getExpiration().getTime() - new Date().getTime() >= 2.5 * 1000 * 60 * 60);
		assertTrue(res.getExpiration().getTime() - new Date().getTime() <= 3.5 * 1000 * 60 * 60);
		return res;
	}
	
	private FBRedeemPoints.Response testRedeemPoints(FoobarService fbs,	long storeKey, String redeemToken)
	{
		FBRedeemPoints cmd = new FBRedeemPoints();
		cmd.setRedeemToken(redeemToken);
		cmd.setStoreKey(storeKey);
		cmd.setPoints(200); // Make this fail!
		
		FBRedeemPoints.Response res = (FBRedeemPoints.Response)fbs.exec(cmd);
		assertFalse(res.isSuccess());
		assertEquals(150, res.getRemainingPoints());
		
		cmd.setPoints(100);
		FBRedeemPoints.Response res2 = (FBRedeemPoints.Response)fbs.exec(cmd);
		assertTrue(res2.isSuccess());
		assertEquals(50, res2.getRemainingPoints());
		return res2;
	}


}